x-node-defaults: &node-defaults
  build: .
  image: flc-node:latest
  networks:
    - flc-net
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
    interval: 10s
    timeout: 5s
    retries: 5
  volumes:
    - ./docker_data/shared:/data
  # FIX: Ensure volume permissions are set before starting
  depends_on:
    init-perms:
      condition: service_completed_successfully

services:
  # --- Infrastructure Services ---
  # Init container to fix volume permissions for non-root user
  init-perms:
    image: busybox
    command: sh -c "mkdir -p /data && chmod 777 /data"
    volumes:
      - ./docker_data/shared:/data
    networks:
      - flc-net

  # --- App Nodes ---
  # Node 0 (Alice) - The "Seed" node that everyone knows initially
  node-0:
    <<: *node-defaults
    container_name: flc-node-0
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=FLC-Node-0
      - SERVER_PORT=8000
      - NODE_ID=user_0
      # Knows Node 1
      - PEERS=http://flc-node-1:8000
      - ADVERTISED_ADDR=http://flc-node-0:8000
      - DB_NAME=/data/user_0.db

  # Node 1
  node-1:
    <<: *node-defaults
    container_name: flc-node-1
    ports:
      - "8001:8000"
    environment:
      - APP_NAME=FLC-Node-1
      - SERVER_PORT=8000
      - NODE_ID=user_1
      # Knows Node 0 and 2 (Ring-like connection to ensure propagation hops)
      - PEERS=http://flc-node-0:8000,http://flc-node-2:8000
      - ADVERTISED_ADDR=http://flc-node-1:8000
      - DB_NAME=/data/user_1.db
    # FIX: Merging dependencies manually as YAML anchors overwrite lists
    depends_on:
      init-perms:
        condition: service_completed_successfully
      node-0:
        condition: service_started

  # Node 2
  node-2:
    <<: *node-defaults
    container_name: flc-node-2
    ports:
      - "8002:8000"
    environment:
      - APP_NAME=FLC-Node-2
      - SERVER_PORT=8000
      - NODE_ID=user_2
      - PEERS=http://flc-node-1:8000,http://flc-node-3:8000
      - ADVERTISED_ADDR=http://flc-node-2:8000
      - DB_NAME=/data/user_2.db

  # Node 3
  node-3:
    <<: *node-defaults
    container_name: flc-node-3
    ports:
      - "8003:8000"
    environment:
      - APP_NAME=FLC-Node-3
      - SERVER_PORT=8000
      - NODE_ID=user_3
      - PEERS=http://flc-node-2:8000,http://flc-node-4:8000
      - ADVERTISED_ADDR=http://flc-node-3:8000
      - DB_NAME=/data/user_3.db

  # Node 4
  node-4:
    <<: *node-defaults
    container_name: flc-node-4
    ports:
      - "8004:8000"
    environment:
      - APP_NAME=FLC-Node-4
      - SERVER_PORT=8000
      - NODE_ID=user_4
      - PEERS=http://flc-node-3:8000,http://flc-node-5:8000
      - ADVERTISED_ADDR=http://flc-node-4:8000
      - DB_NAME=/data/user_4.db

  # Node 5
  node-5:
    <<: *node-defaults
    container_name: flc-node-5
    ports:
      - "8005:8000"
    environment:
      - APP_NAME=FLC-Node-5
      - SERVER_PORT=8000
      - NODE_ID=user_5
      - PEERS=http://flc-node-4:8000,http://flc-node-6:8000
      - ADVERTISED_ADDR=http://flc-node-5:8000
      - DB_NAME=/data/user_5.db

  # Node 6
  node-6:
    <<: *node-defaults
    container_name: flc-node-6
    ports:
      - "8006:8000"
    environment:
      - APP_NAME=FLC-Node-6
      - SERVER_PORT=8000
      - NODE_ID=user_6
      - PEERS=http://flc-node-5:8000,http://flc-node-7:8000
      - ADVERTISED_ADDR=http://flc-node-6:8000
      - DB_NAME=/data/user_6.db

  # Node 7
  node-7:
    <<: *node-defaults
    container_name: flc-node-7
    ports:
      - "8007:8000"
    environment:
      - APP_NAME=FLC-Node-7
      - SERVER_PORT=8000
      - NODE_ID=user_7
      - PEERS=http://flc-node-6:8000,http://flc-node-8:8000
      - ADVERTISED_ADDR=http://flc-node-7:8000
      - DB_NAME=/data/user_7.db

  # Node 8
  node-8:
    <<: *node-defaults
    container_name: flc-node-8
    ports:
      - "8008:8000"
    environment:
      - APP_NAME=FLC-Node-8
      - SERVER_PORT=8000
      - NODE_ID=user_8
      - PEERS=http://flc-node-7:8000,http://flc-node-9:8000
      - ADVERTISED_ADDR=http://flc-node-8:8000
      - DB_NAME=/data/user_8.db

  # Node 9 (Closes the ring)
  node-9:
    <<: *node-defaults
    container_name: flc-node-9
    ports:
      - "8009:8000"
    environment:
      - APP_NAME=FLC-Node-9
      - SERVER_PORT=8000
      - NODE_ID=user_9
      - PEERS=http://flc-node-8:8000,http://flc-node-0:8000
      - ADVERTISED_ADDR=http://flc-node-9:8000
      - DB_NAME=/data/user_9.db

networks:
  flc-net:
    driver: bridge
